<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Newsletter Manager</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#0f172a;padding:20px;color:#e5e7eb}
.container{max-width:850px;margin:0 auto}
.card{
 background:#020617;
 border:1px solid #1f2937;
 border-radius:16px;
 padding:28px;
 box-shadow:0 10px 40px rgba(0,0,0,.4);
 margin-bottom:24px
}
h2{margin-bottom:18px;color:#f8fafc}
.input-group{margin-bottom:15px}
label{display:block;margin-bottom:6px;color:#cbd5f5;font-size:14px}
input{
 width:100%;
 padding:11px;
 border:1px solid #334155;
 border-radius:8px;
 background:#020617;
 color:white
}
button{
 background:#2563eb;
 color:white;
 border:none;
 padding:10px 15px;
 border-radius:8px;
 cursor:pointer;
 margin:6px
}
button:hover{background:#1e40af}
.btn-danger{background:#dc2626}
.btn-danger:hover{background:#991b1b}

.alert{
 padding:12px;border-radius:10px;
 margin-bottom:15px;
 display:none;
 font-size:14px
}
.alert-success{background:#065f46;color:#ecfdf5}
.alert-error{background:#7f1d1d;color:#fee2e2}

.info-box{
 background:#0f172a;
 border:1px solid #1f2937;
 border-radius:12px;
 padding:10px;
 font-size:13px;
 color:#cbd5f5;
 margin-bottom:10px
}

.ids-list{
 background:#020617;
 border-radius:10px;
 padding:15px;
 margin-top:15px;
 max-height:300px;
 overflow-y:auto;
 border:1px solid #1f2937
}
.id-item{
 padding:10px;
 border-bottom:1px solid #1f2937;
 display:flex;
 justify-content:space-between;
 align-items:center
}
.id-item:last-child{border-bottom:none}

.empty-state{text-align:center;padding:25px;color:#64748b}
.timer-display{
 background:#713f12;
 color:#fde68a;
 padding:5px 10px;
 border-radius:8px;
 font-size:12px;
 margin-left:10px
}
button:disabled{opacity:.4;cursor:not-allowed}

.topbar{
 display:flex;
 justify-content:space-between;
 align-items:center
}
.notice{
 background:#1e3a8a;
 color:#bfdbfe;
 padding:10px;
 border-radius:10px;
 margin-top:8px;
 font-size:13px
}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginBox" class="card login-box">
    <h2>Login</h2>
    <div class="input-group">
        <label>Username</label>
        <input type="text" id="username">
    </div>
    <div class="input-group">
        <label>Password</label>
        <input type="password" id="password">
    </div>
    <div id="loginAlert" class="alert"></div>
    <button onclick="login()">Login</button>
</div>

<!-- MAIN -->
<div id="mainBox" class="card main-box" style="display:none">

    <div class="topbar">
        <h2>Newsletter IDs 
            <span id="timerDisplay" class="timer-display" style="display:none">
                Tunggu: 50s
            </span>
        </h2>

        <button onclick="logout()" style="background:#334155">Logout</button>
    </div>

    <div class="notice">
        ‚ö† Data GitHub RAW bisa delay ¬±10‚Äì60 detik karena cache CDN.  
        Sistem ini sudah memakai GitHub API agar lebih realtime.
    </div>

    <div id="alert" class="alert"></div>

    <div class="input-group">
        <label>Tambah ID Baru</label>
        <input id="newId" placeholder="120363xxxx@newsletter">
        <button id="addBtn" onclick="addId()">Tambah</button>
    </div>

    <div class="input-group">
        <label>Hapus ID Spesifik</label>
        <input id="deleteId" placeholder="Paste ID untuk dihapus">
        <button id="deleteSpecificBtn" onclick="deleteSpecific()" class="btn-danger">Hapus</button>
    </div>

    <div>
        <button id="refreshBtn" onclick="loadIds()">Refresh List</button>
        <button id="deleteAllBtn" onclick="deleteAll()" class="btn-danger">Hapus Semua</button>

        <div id="idsList" class="ids-list">
            <div class="empty-state">Loading...</div>
        </div>
    </div>
</div>

<script>
/* ================= CONFIG ================== */
const USERNAME="1";
const PASSWORD="2";
const GITHUB_REPO="BimxyzDev/idch";
const GITHUB_FILE="newsletter.json";
const DELAY_TIME=50000;

const TOKEN_PARTS=[
 "github",
 "_pat_",
 "11BTL4JUA0NxjtCiI1Outu_6OGr4e1YeSXSPn3haoV3oS1aPWBna08JTDNetpD5kZGCUJP76VIiXP8O7JQ"
];
const GITHUB_TOKEN=TOKEN_PARTS.join('');

let currentIds=[];
let currentSha="";
let lastRequestTime=parseInt(localStorage.getItem("lastRequestTime")||"0");
let timerInterval=null;


/* ============= LOGIN SYSTEM ============== */
if(localStorage.getItem("newsletter_auth")==="true"){
 showMain();
 loadIds();
 startTimerCheck();
}

function login(){
 if(username.value===USERNAME && password.value===PASSWORD){
  localStorage.setItem("newsletter_auth","true");
  showMain();
  loadIds();
  startTimerCheck();
  showAlert("Login berhasil","success");
 }else showAlert("Username/password salah","error","loginAlert");
}

function logout(){
 localStorage.removeItem("newsletter_auth");
 if(timerInterval)clearInterval(timerInterval);
 showLogin();
}

function showLogin(){
 loginBox.style.display="block";
 mainBox.style.display="none";
}

function showMain(){
 loginBox.style.display="none";
 mainBox.style.display="block";
}


/* ============= TIMER ================= */
function startTimerCheck(){
 if(timerInterval)clearInterval(timerInterval);
 timerInterval=setInterval(updateTimerDisplay,1000);
 updateTimerDisplay();
}

function getRemainingTime(){
 return Math.max(0,DELAY_TIME-(Date.now()-lastRequestTime));
}

function updateTimerDisplay(){
 const r=getRemainingTime();
 const el=timerDisplay;

 if(r>0){
  el.textContent=`Tunggu: ${Math.ceil(r/1000)}s`;
  el.style.display="inline";
 }else el.style.display="none";

 const enable=r<=0;
 ["addBtn","deleteSpecificBtn","deleteAllBtn","refreshBtn"]
 .forEach(id=>{let b=document.getElementById(id);if(b)b.disabled=!enable});
}

function canMakeRequest(){
 const r=getRemainingTime();
 if(r>0){
  showAlert(`Tunggu ${Math.ceil(r/1000)} detik lagi`,"error");
  return false;
 }
 return true;
}

function setLastRequestTime(){
 lastRequestTime=Date.now();
 localStorage.setItem("lastRequestTime",lastRequestTime);
 updateTimerDisplay();
}


/* ============= ALERT ================= */
function showAlert(msg,type,id="alert"){
 const el=document.getElementById(id);
 el.textContent=msg;
 el.className=`alert alert-${type}`;
 el.style.display="block";
 setTimeout(()=>el.style.display="none",2800);
}


/* ============= LOAD FROM GITHUB API ================= */
async function loadIds(){
 try{
  const r=await fetch(
   `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`,
   {headers:{Authorization:`token ${GITHUB_TOKEN}`}}
  );
  const j=await r.json();
  currentSha=j.sha;

  const decoded=decodeURIComponent(escape(atob(j.content)));
  const arr=JSON.parse(decoded);

  currentIds=Array.isArray(arr)?arr:[];
 }catch(e){
  currentIds=[];
 }

 renderIds();
 showAlert(`Loaded ${currentIds.length} IDs`,"success");
}


/* ============= RENDER ================= */
function renderIds(){
 const list=document.getElementById("idsList");
 if(!currentIds.length){
  list.innerHTML='<div class="empty-state">Tidak ada ID</div>';
  return;
 }

 list.innerHTML=currentIds.map(id=>`
 <div class="id-item">
   <span>${id}</span>
   <div>
     <button class="icon-btn" onclick="copyId('${id}')">üìã</button>
     <button class="icon-btn" onclick="deleteSingle('${id}')" style="color:#dc2626">üóëÔ∏è</button>
   </div>
 </div>`).join("");
}


/* ============= SAVE ================= */
async function saveToGithub(arr,msg){
 const c=btoa(unescape(encodeURIComponent(JSON.stringify(arr,null,2))));

 await fetch(
  `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`,
  {
   method:"PUT",
   headers:{Authorization:`token ${GITHUB_TOKEN}`},
   body:JSON.stringify({message:msg,content:c,sha:currentSha})
  });

 await loadIds();
}


/* ============= ACTIONS ================= */

async function addId(){
 if(!canMakeRequest())return;
 const id=newId.value.trim();
 if(!id)return showAlert("Masukkan ID","error");
 if(!id.includes("@newsletter"))return showAlert("Format salah","error");

 setLastRequestTime();
 await loadIds();

 if(currentIds.includes(id))return showAlert("Sudah ada","error");

 await saveToGithub([...currentIds,id],`Add ID: ${id}`);
 newId.value="";
 showAlert("Berhasil","success");
}

async function deleteSpecific(){
 if(!canMakeRequest())return;
 const id=deleteId.value.trim();
 if(!id)return showAlert("Masukkan ID","error");
 deleteId.value="";
 await deleteSingle(id);
}

async function deleteSingle(id){
 if(!confirm(`Hapus ${id}?`))return;
 if(!canMakeRequest())return;

 setLastRequestTime();
 await loadIds();

 await saveToGithub(currentIds.filter(x=>x!==id),`Delete ID: ${id}`);
 showAlert("Dihapus","success");
}

async function deleteAll(){
 if(!currentIds.length)return showAlert("Tidak ada ID","error");
 if(!confirm(`Hapus semua?`))return;
 if(!canMakeRequest())return;

 setLastRequestTime();
 await saveToGithub([],`Delete all IDs`);
 showAlert("Bersih","success");
}

function copyId(id){
 navigator.clipboard.writeText(id);
 showAlert("ID disalin","success");
}
</script>

</body>
    </html>
