<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        body { background: #f0f0f0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .login-box { max-width: 400px; margin: 100px auto; }
        .main-box { display: none; }
        h2 { margin-bottom: 20px; color: #333; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .alert { padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; }
        .ids-list { background: #f8f9fa; border-radius: 5px; padding: 15px; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .id-item { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
        .id-item:last-child { border-bottom: none; }
        .icon-btn { background: none; border: none; cursor: pointer; margin-left: 10px; }
        .empty-state { text-align: center; padding: 20px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">

        <div id="loginBox" class="card login-box">
            <h2>Login</h2>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="username">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="password">
            </div>
            <div id="loginAlert" class="alert"></div>
            <button onclick="login()">Login</button>
        </div>

        <div id="mainBox" class="card main-box">
            <h2>Newsletter IDs</h2>

            <button onclick="logout()" style="float:right; background:#6c757d;">Logout</button>

            <div id="alert" class="alert"></div>

            <div class="input-group">
                <label>Tambah ID Baru</label>
                <input type="text" id="newId" placeholder="120363403152040979@newsletter">
                <button onclick="addId()">Tambah</button>
            </div>

            <div class="input-group">
                <label>Hapus ID Spesifik</label>
                <input type="text" id="deleteId" placeholder="Paste ID untuk dihapus">
                <button onclick="deleteSpecific()" class="btn-danger">Hapus</button>
            </div>

            <div>
                <button onclick="loadIds()">Refresh List</button>
                <button onclick="deleteAll()" class="btn-danger">Hapus Semua</button>

                <div id="idsList" class="ids-list">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>
        </div>
    </div>

<script>
const USERNAME="1";
const PASSWORD="2";
const GITHUB_REPO="BimxyzDev/idch";
const GITHUB_FILE="newsletter.json";

const TOKEN_PARTS=[
 "github",
 "_pat_",
 "11BTL4JUA0NxjtCiI1Outu_6OGr4e1YeSXSPn3haoV3oS1aPWBna08JTDNetpD5kZGCUJP76VIiXP8O7JQ"
];
const GITHUB_TOKEN=TOKEN_PARTS.join('');

let currentIds=[];

if(localStorage.getItem("newsletter_auth")==="true"){
    showMain();
    loadIds();
}

function login(){
    if(
      document.getElementById("username").value===USERNAME &&
      document.getElementById("password").value===PASSWORD
    ){
        localStorage.setItem("newsletter_auth","true");
        showMain();
        loadIds();
        showAlert("Login berhasil","success");
    }else showAlert("Username/password salah","error","loginAlert");
}

function logout(){
    localStorage.removeItem("newsletter_auth");
    showLogin();
}

function showLogin(){
    loginBox.style.display="block";
    mainBox.style.display="none";
}

function showMain(){
    loginBox.style.display="none";
    mainBox.style.display="block";
}

function showAlert(msg,type,id="alert"){
    const el=document.getElementById(id);
    el.textContent=msg;
    el.className="alert alert-"+type;
    el.style.display="block";
    setTimeout(()=>el.style.display="none",2500);
}

// =============== FETCH LATEST DATA + SHA ===============

async function fetchLatestFile(){
    const res=await fetch(
        `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`,
        { headers:{Authorization:`token ${GITHUB_TOKEN}`} }
    );

    const data=await res.json();

    const decoded=decodeURIComponent(escape(atob(data.content)));
    const arr=JSON.parse(decoded);

    return { ids:Array.isArray(arr)?arr:[], sha:data.sha };
}

// ================= LOAD LIST =================

async function loadIds(){
    try{
        const url=`https://raw.githubusercontent.com/${GITHUB_REPO}/main/${GITHUB_FILE}?t=${Date.now()}`;
        const res=await fetch(url);
        currentIds=await res.json();
        renderIds();
        showAlert(`Loaded ${currentIds.length} IDs`,"success");
    }catch(e){
        currentIds=[];
        renderIds();
        showAlert("Gagal load data","error");
    }
}

function renderIds(){
    const box=document.getElementById("idsList");
    if(!currentIds.length){
        box.innerHTML=`<div class="empty-state">Tidak ada ID</div>`;
        return;
    }
    box.innerHTML=currentIds.map(id=>`
        <div class="id-item">
            <span>${id}</span>
            <div>
                <button class="icon-btn" onclick="copyId('${id}')">üìã</button>
                <button class="icon-btn" onclick="deleteSingle('${id}')">üóëÔ∏è</button>
            </div>
        </div>
    `).join("");
}

// ================== UPDATE GITHUB (SAFE) ==================

async function pushUpdate(updatedIds){
    const latest = await fetchLatestFile();

    const content=btoa(unescape(encodeURIComponent(JSON.stringify(updatedIds,null,2))));

    await fetch(
        `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`,
        {
            method:"PUT",
            headers:{
                Authorization:`token ${GITHUB_TOKEN}`,
                "Content-Type":"application/json"
            },
            body:JSON.stringify({
                message:"Update newsletter IDs",
                content,
                branch:"main",
                sha:latest.sha
            })
        }
    );
}

// ================== ADD ==================

async function addId(){
    const newId=newId.value.trim();
    if(!newId) return showAlert("Masukkan ID","error");
    if(!newId.includes("@newsletter")) return showAlert("Harus ada @newsletter","error");

    const latest = await fetchLatestFile();

    if(latest.ids.includes(newId))
        return showAlert("ID sudah ada","error");

    latest.ids.push(newId);

    await pushUpdate(latest.ids);

    currentIds=latest.ids;
    renderIds();
    newId.value="";

    showAlert("ID ditambahkan","success");
}

// ================== DELETE ONE ==================

async function deleteSingle(id){
    if(!confirm("Hapus "+id+"?")) return;

    const latest = await fetchLatestFile();

    latest.ids = latest.ids.filter(x=>x!==id);

    await pushUpdate(latest.ids);

    currentIds=latest.ids;
    renderIds();

    showAlert("ID dihapus","success");
}

// ================== DELETE ALL ==================

async function deleteAll(){
    if(!currentIds.length) return showAlert("Kosong","error");
    if(!confirm("Hapus semua ID?")) return;

    await pushUpdate([]);

    currentIds=[];
    renderIds();

    showAlert("Semua ID dihapus","success");
}

// ================== COPY ==================

function copyId(id){
    navigator.clipboard.writeText(id);
    showAlert("Disalin","success");
}
</script>

</body>
</html>
